var app=angular.module("MyApp",["ngRoute","luegg.directives"]);var Host="https://achat-spring.onrender.com/";firebase.initializeApp({apiKey:"AIzaSyBda0kNa2ttsIZ2N8Litr6L3HQ_w5Hk76s",authDomain:"achat-1a4cf.firebaseapp.com",databaseURL:"https://achat-1a4cf-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"achat-1a4cf",storageBucket:"achat-1a4cf.appspot.com",messagingSenderId:"963042451652",appId:"1:963042451652:web:f71245f61997f79d232991",measurementId:"G-YKKR88WZ1J"});var db=firebase.firestore();var docRef;app.controller("MyCtrl",["$scope","$rootScope","$http","$location","$interval",function($scope,$rootScope,$http,$location,$interval){$rootScope.Page="AChat";$rootScope.isAnonymous;$rootScope.MyAccount;$rootScope.Notification;$scope.isLoadedFail=false;$rootScope.viewFriend={chatID:null,fullname:null,avatar:null,gender:null,ListMessages:undefined};$rootScope.Theme=localStorage.getItem("UserThemeSetting");$rootScope.changeView=function(Chat){docRef=db.collection("AChat_Conversations").doc(Chat.chatID+"");$rootScope.viewFriend.chatID=angular.copy(Chat.chatID);$rootScope.viewFriend.fullname=angular.copy(Chat.fullname);$rootScope.viewFriend.avatar=$scope.GenAvatar(Chat);$rootScope.viewFriend.gender=angular.copy(Chat.gender);$scope.loadMessages(Chat.chatID);docRef.onSnapshot(function(newData){$scope.$apply(function(){$rootScope.viewFriend.ListMessages=angular.copy(newData.data().messages)})})};$scope.clearView=function(){$rootScope.viewFriend={chatID:null,fullname:null,avatar:null,gender:null,link:null,ListMessages:undefined}};$scope.loadMessages=function(chatID){docRef.get().then(function(data){$scope.$apply(function(){if(data.exists){$rootScope.viewFriend.ListMessages=angular.copy(data.data().messages);$scope.isLoadedFail=true}else{docRef.set({messages:[]}).then(function(){$scope.ProcessSuccess("Khởi tạo cuộc trò chuyện thành công.");$scope.loadMessages(chatID)})["catch"](function(error){$scope.ProcessError("Không thể khởi tạo cuộc trò chuyện !")})}})})["catch"](function(error){$scope.ProcessError("Không thể truy cập cuộc trò chuyện !")})};$scope.SendMessageOnEnter=function(event){if(event.key==="Enter"){event.preventDefault();$scope.SendMessage()}};$scope.SendMessage=function(){if($scope.TypingText!=null&&$scope.MyAccount){var message={Content:$scope.TypingText,Time:new Date,Sender:$rootScope.MyAccount.userId};$scope.SendMessageToServer(message)}};$scope.SendMessageToServer=function(message){document.getElementById("txtText").disabled=true;docRef.update({messages:firebase.firestore.FieldValue.arrayUnion(message)}).then(function(){$scope.$apply(function(){$scope.TypingText="";document.getElementById("txtText").blur();document.getElementById("txtText").disabled=false;document.getElementById("txtText").focus()})})["catch"](function(error){$scope.$apply(function(){setTimeout(function(){location.reload()},1e3);$scope.ProcessError("Không thể gửi tin nhắn !!")})})};$scope.removeMessages=function(isConfirm,chatID){if(!isConfirm)document.getElementById("OUT_CHATS").click();else{var images=$rootScope.viewFriend.ListMessages.filter(m=>{return m.Image!=null}).map(m=>{return m.Image});$http({method:"POST",url:Host+"Chats/DeleteChats",data:"chatID="+chatID+"&listImage="+images,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function successCallback(response){docRef["delete"]();$rootScope.viewFriend.ListMessages=undefined;$scope.ProcessSuccess("Dữ liệu trò chuyện đã được xoá.");setTimeout(function(){location.reload()},1e3)},function errorCallback(response){$scope.ProcessError(response)})}};$scope.ProcessUser=function(User){$rootScope.isAnonymous=$scope.validatedIP(User.email);$rootScope.MyAccount=angular.copy(User);$rootScope.MyAccount.password=null;$rootScope.MyAccount.gender+="";$rootScope.MyAccount.excitedGender+="";$rootScope.MyAccount.age+="";$rootScope.MyAccount.excitedAge+="";$location.path("/AChat");$scope.GetChats($rootScope.MyAccount.userId)};$scope.GetChats=function(userId){$http({method:"POST",url:Host+"Chats/GetChats",data:"userId="+userId,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function successCallback(response){$rootScope.MyAccount.listChats=angular.copy(response.data)},function errorCallback(response){$scope.ProcessError(response)})};$scope.ProcessSuccess=function(response){new bootstrap.Toast(document.getElementById("ToastError")).hide();$rootScope.Notification="Cập nhật thông tin thành công.";if(typeof response==="string"||response instanceof String)$rootScope.Notification=response;else console.log("Success Info: ",response);new bootstrap.Toast(document.getElementById("ToastSuccess")).show()};$scope.ProcessError=function(response){new bootstrap.Toast(document.getElementById("ToastSuccess")).hide();$rootScope.Notification=response.data?response.data.message:"Không thể kết nối tới máy chủ.";if(typeof response==="string"||response instanceof String)$rootScope.Notification=response;else console.log("Error Info: ",response);new bootstrap.Toast(document.getElementById("ToastError")).show();if(response.data.acode){if(response.data.acode=="FA_SIGNIN_EM")$location.path("/Account");document.getElementById(response.data.acode).click();console.log("Error Code: ",response.data.acode)}};$scope.Authen=function(){if(!$rootScope.MyAccount){var hash=localStorage.getItem("SignInHash");if(hash){const SignInHash=CryptoJS.AES.decrypt(hash,"AChat Spring By AnLaVN").toString(CryptoJS.enc.Utf8).split("~");$scope.User("SignIn",{email:SignInHash[0],password:SignInHash[1]})}else if(localStorage.getItem("SignInDevice")=="IP")$scope.Anonymous("SignUp");else $location.path("/Account")}};$scope.Anonymous=function(Controller){$http.get("https://api.ipify.org/?format=json").then(function(response){$http({method:"POST",url:Host+"Account/Anonymous"+Controller,data:"email="+response.data.ip,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function successCallback(response){localStorage.removeItem("SignInHash");localStorage.setItem("SignInDevice","IP");$scope.ProcessUser(response.data);$scope.ProcessSuccess("Đăng nhập bằng thiết bị thành công.")},function errorCallback(response){if(Controller=="SignUp"&&response.data&&response.data.acode=="FA_SIGNUP_IP")$scope.Anonymous("SignIn");else $scope.ProcessError(response)})})};$scope.User=function(Controller,User){$http({method:"POST",url:Host+"Account/User"+Controller,data:"email="+User.email+"&password="+User.password+(User.fullname?"&fullname="+User.fullname:""),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function successCallback(response){localStorage.removeItem("SignInDevice");if(User.remmember){var hash=CryptoJS.AES.encrypt(User.email+"~"+User.password,"AChat Spring By AnLaVN");localStorage.setItem("SignInHash",hash)}$scope.ProcessUser(response.data);$rootScope.MyAccount.password=User.password;$scope.ProcessSuccess("Đăng nhập bằng tài khoản email thành công.")},function errorCallback(response){$scope.ProcessError(response)})};$scope.UserInfor=function(param,value){$http({method:"POST",url:Host+"Account/UserUpdate",data:"userId="+$rootScope.MyAccount.userId+"&"+param+"="+value,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function successCallback(response){$scope.ProcessSuccess(response.data)},function errorCallback(response){$scope.ProcessError(response)})};$scope.UserAcc=function(){if(document.getElementById("UpdateAccForm").checkValidity()){$http({method:"POST",url:Host+"Account/UserUpdate",data:"userId="+$rootScope.MyAccount.userId+"&fullname="+$rootScope.MyAccount.fullname+"&email="+$rootScope.MyAccount.email+"&password="+$rootScope.MyAccount.password,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function successCallback(response){$scope.ProcessSuccess(response.data)},function errorCallback(response){$scope.ProcessError(response)})}};$scope.SignOut=function(){$rootScope.MyAccount=null;localStorage.removeItem("SignInDevice");localStorage.removeItem("SignInHash");location.reload()};$scope.Deactivate=function(isConfirm,email,password){if(!isConfirm)document.getElementById("Deactivate").click();else{console.log(email,password);$http({method:"POST",url:Host+"Account/Deactivate",data:"email="+email+(password?"&password="+password:""),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function successCallback(response){$scope.ProcessSuccess("Tài khoản đã được huỷ kích hoạt.")},function errorCallback(response){$scope.ProcessError(response)});setTimeout(function(){$scope.SignOut()},3e3)}};$scope.$watch("$resolve",function(value){$rootScope.Page=value.$resolve});$rootScope.ChangeTheme=function(){$rootScope.Theme=$rootScope.Theme=="dark"?"light":"dark";localStorage.setItem("UserThemeSetting",$rootScope.Theme)};$scope.GenAvatar=function(User){User.gender+="";return User.avatar?User.avatar:"Resources/Images/"+(User.gender=="null"?"None":User.gender=="true"?"Female":"Male")+".svg"};$scope.validatedIP=function(IP){return/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(IP)};$scope.loadTooltips=function(){const tooltipTriggerList=document.querySelectorAll('[data-bs-toggle="tooltip"]');[...tooltipTriggerList].map(tooltipTriggerEl=>new bootstrap.Tooltip(tooltipTriggerEl))};$scope.LoadEmojiMenu=function(){function insertEmoji(emoji){document.getElementById("txtText").value+=emoji;$scope.TypingText+=emoji}const AvailableLanguages=["en","ar","be","cs","de","es","fa","fi","fr","hi","it","ja","kr","nl","pl","pt","ru","sa","tr","uk","vi","zh"];const BrowserLanguage=(navigator.language||navigator.userLanguage).slice(0,2);const EmojiLanguage=AvailableLanguages.includes(BrowserLanguage)?BrowserLanguage:"en";const picker=new EmojiMart.Picker({onEmojiSelect:emoji=>insertEmoji(emoji["native"]),theme:"light",locale:EmojiLanguage});document.getElementById("EmojiMenu").appendChild(picker)};$scope.LoadCoudinary=function(){const myWidget=cloudinary.createUploadWidget({cloudName:"anlavn",uploadPreset:"AChat-Images_Preset",cropping:true,sources:["local","url"],clientAllowedFormats:["png","jpg","jpeg","gif"],maxImageFileSize:3e6},(error,result)=>{if(!error&&result&&result.event==="success"&&$rootScope.MyAccount){var message={Image:result.info.public_id,Time:new Date,Sender:$rootScope.MyAccount.userId};$scope.SendMessageToServer(message)}});document.getElementById("upload_widget").addEventListener("click",function(){myWidget.open()})};$scope.Validation=function(){const forms=document.querySelectorAll(".needs-validation");Array.from(forms).forEach(form=>{form.addEventListener("submit",event=>{if(!form.checkValidity()){event.preventDefault();event.stopPropagation()}form.classList.add("was-validated")},false)})}}]);app.config(function($routeProvider){$routeProvider.when("/AChat",{templateUrl:"Resources/Layout/AChat.html",controller:"MyCtrl",resolve:{$resolve:function(){return"AChat"}}}).when("/Account",{templateUrl:"Resources/Layout/Account.html",controller:"MyCtrl",resolve:{$resolve:function(){return"Account"}}}).when("/Error",{templateUrl:"Resources/Layout/Error.html",controller:"MyCtrl",resolve:{$resolve:function(){return"Error"}}}).otherwise({redirectTo:"/AChat"})});app.directive("imageonload",function(){return{restrict:"A",link:function(scope,element,attrs){element.bind("load",function(){scope.$apply(attrs.imageonload)})}}});